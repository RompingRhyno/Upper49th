@using Customer.Membership.Models
@using Grand.Business.Core.Interfaces.Checkout.Payments
@inject IPaymentService PaymentService


@model MembershipModel
@{
    Layout = "_Layout";
    var paymentMethods = await PaymentService.LoadActivePaymentMethods(customer: null);
}

<h2>Choose a Membership Plan</h2>

<div id="plans">
    @foreach (var plan in Model.AvailablePlans)
    {
        <div class="plan">
            <h4>@plan.Role</h4>
            <p><strong>@plan.Price</strong></p>
            <button type="button" class="membership-btn" data-plan="@plan.Role">Select @plan.Role</button>
        </div>
    }
</div>

<div id="step-billing" class="card">
    <b-collapse id="opc-billing" accordion="my-accordion" role="tabpanel">
        <div class="card-body">
            <validation-observer v-slot="{ handleSubmit }">
                <form id="co-billing-form" method="post" asp-action="SaveBilling">
                    <div id="checkout-billing-load">
                        @await Html.PartialAsync("BillingWithoutShipping", Model.BillingAddressModel)
                    </div>
                    <input type="submit" id="opc-billing-submit" class="d-none" />
                </form>
            </validation-observer>
            <div class="col-12 buttons py-1 mt-3 px-0" id="billing-buttons-container">
                <input type="button" class="btn btn-info new-address-next-step-button" onclick="submitBillingForm()" value="Continue" />
                <span class="please-wait" id="billing-please-wait" style="display: none;">Loading next step...</span>
            </div>
        </div>
    </b-collapse>
</div>

<form method="post" asp-action="Pay">
    <input type="hidden" id="SelectedPlan" name="SelectedPlan" />
    <select name="SelectedPaymentMethod" required>
        @foreach (var method in paymentMethods)
        {
            <option value="@method.SystemName">@method.FriendlyName</option>
        }
    </select>

    <button type="submit">Submit and Pay</button>
</form>

@section Styles {
    <link rel="stylesheet" href="~/plugins/Customer.Membership/css/membership.css" />
}

@section Scripts {
    <script>
        let selectedPlan = "";

        document.querySelectorAll(".membership-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                selectedPlan = this.dataset.plan;
                document.getElementById("SelectedPlan").value = selectedPlan;

                document.querySelectorAll(".membership-btn").forEach(b => b.classList.remove("selected"));
                this.classList.add("selected");

                console.log("Selected plan:", selectedPlan);
            });
        });


    let currentStep = 0;
    const steps = ['step-billing', 'step-payment-method', 'step-payment-info', 'step-confirm'];

    function showStep(stepIndex) {
        steps.forEach((stepId, index) => {
            document.getElementById(stepId).style.display = index === stepIndex ? 'block' : 'none';
        });
        currentStep = stepIndex;
    }

    function nextStep() {
        if (currentStep < steps.length - 1) {
            showStep(currentStep + 1);
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            showStep(currentStep - 1);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        showStep(0); // Start at billing
    });
    </script>
}